<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podsumowanie Zamówienia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
</head>
<body>
    <header>
        <div class="logo">
            <a href="/" class="logo-link"><i class="fa-solid fa-shop"></i></a>
        </div>
        <div class="header-title" style="font-size: 20px; font-weight: bold;">
            Finalizacja Zamówienia
        </div>
        <div class="user-actions">
            <a href="koszyk.html" style="font-size: 14px; text-decoration: underline;">Wróć do koszyka</a>
        </div>
    </header>

    <div class="layout-container">
        <div class="checkout-layout">
            
        <div class="checkout-left">
            
            {% if adres %}
            <div id="default-address-section">
                <div class="default-address-card">
                    <h3><i class="fa-solid fa-house-user"></i> Adres do wysyłki</h3>
                    <p>
                        <strong>{{ adres.ulica }} {{ adres.nr_domu }}{% if adres.nr_lokalu %}/{{ adres.nr_lokalu }}{% endif %}</strong><br>
                        {{ adres.kod_pocztowy }} {{ adres.miejscowosc }}
                    </p>
                    
                    <form action="/order/submit" method="POST" onsubmit="prepareCart(this)">
                        <input type="hidden" name="cart_json" class="cart-data-input">
                        <input type="hidden" name="use_default" value="true">
                        <button type="submit" class="login-btn" style="background: #28a745;">
                            Zamawiam na ten adres
                        </button>
                    </form>

                    <div class="address-actions">
                        <button type="button" class="btn-small" onclick="editDefaultAddress()">Edytuj dane</button>
                        <button type="button" class="btn-small" onclick="showNewAddressForm()">Inny adres</button>
                    </div>
                </div>
            </div>
            {% endif %}

            <div id="checkout-form-container" class="{% if adres %}hidden{% endif %}">
                <div class="checkout-box">
                    <h2>Wprowadź dane dostawy</h2>
                    <form action="/order/submit" method="POST" id="order-form" onsubmit="prepareCart(this)">
                        <input type="hidden" name="cart_json" class="cart-data-input">

                        <div class="form-group">
                            <label>Ulica</label>
                            <div class="input-wrapper">
                                <input type="text" name="ulica" id="input-ulica" required>
                            </div>
                        </div>

                        <div class="form-row" style="display: flex; gap: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <label>Nr domu</label>
                                <div class="input-wrapper">
                                    <input type="text" name="nr_domu" id="input-nr_domu" required>
                                </div>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Nr lokalu</label>
                                <div class="input-wrapper">
                                    <input type="text" name="nr_lokalu" id="input-nr_lokalu">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="login-btn">Finalizuj zamówienie</button>
                        
                        {% if adres %}
                        <button type="button" class="btn-toggle-form" onclick="cancelNewAddress()" style="margin-top: 10px; border: none; background: none; text-decoration: underline;">
                            Wróć do adresu domyślnego
                        </button>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>

    {% if adres %}
<script>
    // Deklarujemy zmienną tylko RAZ.
    let defaultAddressData = null; 

    // Używamy Jinja, aby wypełnić obiekt tylko jeśli adres istnieje.
    {% if adres %}
    defaultAddressData = {
        ulica: "{{ adres.ulica }}",
        nr_domu: "{{ adres.nr_domu }}",
        nr_lokalu: "{{ adres.nr_lokalu or '' }}",
        kod: "{{ adres.kod_pocztowy }}",
        miasto: "{{ adres.miejscowosc }}"
    };
    {% endif %}
    
    // Teraz Twoja funkcja showNewAddressForm() i reszta logiki...
</script>
        // --- LOGIKA PRZEŁĄCZANIA WIDOKÓW ---
        
        function showNewAddressForm() {
            document.getElementById('default-address-section').style.display = 'none';
            document.getElementById('checkout-form-container').style.display = 'block';
            // Czyścimy formularz, bo to "nowy adres"
            document.getElementById('order-form').reset();
            // Przywracamy wartość ukrytego pola koszyka (bo reset() mógł go wyczyścić)
            fillCartData();
        }

        function cancelNewAddress() {
            document.getElementById('default-address-section').style.display = 'block';
            document.getElementById('checkout-form-container').style.display = 'none';
        }

        function editDefaultAddress() {
            // 1. Pokaż formularz
            document.getElementById('default-address-section').style.display = 'none';
            document.getElementById('checkout-form-container').style.display = 'block';
            
            // 2. Wypełnij formularz danymi domyślnymi
            if (defaultAddressData) {
                document.getElementById('input-ulica').value = defaultAddressData.ulica;
                document.getElementById('input-nr_domu').value = defaultAddressData.nr_domu;
                document.getElementById('input-nr_lokalu').value = defaultAddressData.nr_lokalu;
                document.getElementById('input-kod').value = defaultAddressData.kod;
                document.getElementById('input-miasto').value = defaultAddressData.miasto;
                // Zaznacz checkbox, bo to w końcu domyślny
                document.getElementById('save_default').checked = true;
            }
        }

        function fillCartData() {
            const cart = localStorage.getItem('myShopCart');
            if (cart) {
                document.getElementById('cart-json-input').value = cart;
            }
        }

        // --- LOGIKA MINI KOSZYKA (JS) ---
        document.addEventListener('DOMContentLoaded', async () => {
            fillCartData();
            
            const cartJson = localStorage.getItem('myShopCart');
            if (!cartJson || JSON.parse(cartJson).length === 0) {
                alert("Twój koszyk jest pusty!");
                window.location.href = "/koszyk.html";
                return;
            }

            const cart = JSON.parse(cartJson);
            const ids = cart.map(item => item.id);

            // Pobierz szczegóły produktów z API
            try {
                const response = await fetch('/api/products-details', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ids)
                });
                const products = await response.json();
                
                const container = document.getElementById('mini-cart-items');
                container.innerHTML = '';
                let total = 0;

                cart.forEach(cartItem => {
                    const product = products.find(p => p.id === cartItem.id);
                    if (!product) return;

                    const subtotal = product.price * cartItem.qty;
                    total += subtotal;

                    const html = `
                        <div class="mini-cart-item">
                            <img src="${product.image || 'https://placehold.co/50'}" alt="">
                            <div class="mini-cart-info">
                                <span class="mini-cart-title">${product.name}</span>
                                <div class="mini-cart-meta">
                                    ${cartItem.qty} szt. x ${product.price} zł
                                </div>
                            </div>
                            <div style="font-weight: bold;">
                                ${subtotal.toFixed(2)} zł
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });

                document.getElementById('mini-cart-total-price').innerText = total.toFixed(2) + " zł";

            } catch (error) {
                console.error(error);
                document.getElementById('mini-cart-items').innerText = "Błąd wczytywania produktów.";
            }
        });
    </script>
</body>
</html>