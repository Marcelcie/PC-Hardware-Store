<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podsumowanie Zamówienia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
</head>
<body>
    <header>
        <div class="logo">
            <a href="/" class="logo-link"><i class="fa-solid fa-shop"></i></a>
        </div>
        <div class="header-title" style="font-size: 20px; font-weight: bold;">
            Finalizacja Zamówienia
        </div>
        <div class="user-actions">
            <a href="koszyk.html" style="font-size: 14px; text-decoration: underline;">Wróć do koszyka</a>
        </div>
    </header>

    <div class="layout-container">
        <div class="checkout-layout">
            
            <div class="checkout-left">
                
                {% if adres %}
                <div id="default-address-section">
                    <div class="default-address-card">
                        <h3><i class="fa-solid fa-location-dot"></i> Twój domyślny adres dostawy</h3>
                        <p>
                            <strong>{{ adres.ulica }} {{ adres.nr_domu }}{% if adres.nr_lokalu %}/{{ adres.nr_lokalu }}{% endif %}</strong><br>
                            {{ adres.kod_pocztowy }} {{ adres.miejscowosc }}
                        </p>
                        <div class="address-actions">
                            <button type="button" class="btn-small" onclick="editDefaultAddress()">
                                <i class="fa-solid fa-pen"></i> Edytuj / Użyj tego
                            </button>
                            <form action="/address/remove-default" method="POST" style="display:inline;">
                                <button type="submit" class="btn-small delete">
                                    <i class="fa-solid fa-trash"></i> Usuń domyślny
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="separator-text">LUB</div>

                    <button type="button" class="btn-toggle-form" onclick="showNewAddressForm()">
                        <i class="fa-solid fa-plus"></i> Wybierz / Dodaj nowy adres
                    </button>
                </div>
                {% endif %}

                <div id="checkout-form-container" style="{% if adres %}display: none;{% endif %}">
                    <div class="checkout-box" style="border: 1px solid #007bff;">
                        <h2 style="margin-top: 0;">Dane do wysyłki</h2>
                        
                        <form action="/order/submit" method="POST" id="order-form">
                            <input type="hidden" name="cart_json" id="cart-json-input">

                            <div class="form-group">
                                <label>Ulica</label>
                                <input type="text" name="ulica" id="input-ulica" required class="full-width">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nr domu</label>
                                    <input type="text" name="nr_domu" id="input-nr_domu" required>
                                </div>
                                <div class="form-group">
                                    <label>Nr lokalu</label>
                                    <input type="text" name="nr_lokalu" id="input-nr_lokalu">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Kod pocztowy</label>
                                    <input type="text" name="kod_pocztowy" id="input-kod" required pattern="[0-9]{2}-[0-9]{3}" placeholder="00-000">
                                </div>
                                <div class="form-group">
                                    <label>Miejscowość</label>
                                    <input type="text" name="miejscowosc" id="input-miasto" required>
                                </div>
                            </div>

                            <div class="form-group-checkbox" style="margin-bottom: 20px; background: #f9f9f9; padding: 10px; border-radius: 4px;">
                                <input type="checkbox" id="save_default" name="save_default" value="true">
                                <label for="save_default">Zapisz ten adres jako domyślny</label>
                            </div>

                            <button type="submit" class="login-btn">Zatwierdź i Zamów</button>
                            
                            {% if adres %}
                            <button type="button" class="btn-small" style="width: 100%; margin-top: 10px; text-align: center;" onclick="cancelNewAddress()">
                                Anuluj i wróć do domyślnego
                            </button>
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div>

            <div class="checkout-right">
                <h3>Podsumowanie zamówienia</h3>
                <div id="mini-cart-items">
                    <p style="color: #999;">Ładowanie produktów...</p>
                </div>
                
                <div class="mini-cart-total">
                    <span>Razem:</span>
                    <span id="mini-cart-total-price">0.00 zł</span>
                </div>
            </div>

        </div>
    </div>

    {% if adres %}
    <script>
        const defaultAddressData = {
            ulica: "{{ adres.ulica }}",
            nr_domu: "{{ adres.nr_domu }}",
            nr_lokalu: "{{ adres.nr_lokalu or '' }}",
            kod: "{{ adres.kod_pocztowy }}",
            miasto: "{{ adres.miejscowosc }}"
        };
    </script>
    {% else %}
    <script>const defaultAddressData = null;</script>
    {% endif %}

    <script>
        // --- LOGIKA PRZEŁĄCZANIA WIDOKÓW ---
        
        function showNewAddressForm() {
            document.getElementById('default-address-section').style.display = 'none';
            document.getElementById('checkout-form-container').style.display = 'block';
            // Czyścimy formularz, bo to "nowy adres"
            document.getElementById('order-form').reset();
            // Przywracamy wartość ukrytego pola koszyka (bo reset() mógł go wyczyścić)
            fillCartData();
        }

        function cancelNewAddress() {
            document.getElementById('default-address-section').style.display = 'block';
            document.getElementById('checkout-form-container').style.display = 'none';
        }

        function editDefaultAddress() {
            // 1. Pokaż formularz
            document.getElementById('default-address-section').style.display = 'none';
            document.getElementById('checkout-form-container').style.display = 'block';
            
            // 2. Wypełnij formularz danymi domyślnymi
            if (defaultAddressData) {
                document.getElementById('input-ulica').value = defaultAddressData.ulica;
                document.getElementById('input-nr_domu').value = defaultAddressData.nr_domu;
                document.getElementById('input-nr_lokalu').value = defaultAddressData.nr_lokalu;
                document.getElementById('input-kod').value = defaultAddressData.kod;
                document.getElementById('input-miasto').value = defaultAddressData.miasto;
                // Zaznacz checkbox, bo to w końcu domyślny
                document.getElementById('save_default').checked = true;
            }
        }

        function fillCartData() {
            const cart = localStorage.getItem('myShopCart');
            if (cart) {
                document.getElementById('cart-json-input').value = cart;
            }
        }

        // --- LOGIKA MINI KOSZYKA (JS) ---
        document.addEventListener('DOMContentLoaded', async () => {
            fillCartData();
            
            const cartJson = localStorage.getItem('myShopCart');
            if (!cartJson || JSON.parse(cartJson).length === 0) {
                alert("Twój koszyk jest pusty!");
                window.location.href = "/koszyk.html";
                return;
            }

            const cart = JSON.parse(cartJson);
            const ids = cart.map(item => item.id);

            // Pobierz szczegóły produktów z API
            try {
                const response = await fetch('/api/products-details', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ids)
                });
                const products = await response.json();
                
                const container = document.getElementById('mini-cart-items');
                container.innerHTML = '';
                let total = 0;

                cart.forEach(cartItem => {
                    const product = products.find(p => p.id === cartItem.id);
                    if (!product) return;

                    const subtotal = product.price * cartItem.qty;
                    total += subtotal;

                    const html = `
                        <div class="mini-cart-item">
                            <img src="${product.image || 'https://placehold.co/50'}" alt="">
                            <div class="mini-cart-info">
                                <span class="mini-cart-title">${product.name}</span>
                                <div class="mini-cart-meta">
                                    ${cartItem.qty} szt. x ${product.price} zł
                                </div>
                            </div>
                            <div style="font-weight: bold;">
                                ${subtotal.toFixed(2)} zł
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });

                document.getElementById('mini-cart-total-price').innerText = total.toFixed(2) + " zł";

            } catch (error) {
                console.error(error);
                document.getElementById('mini-cart-items').innerText = "Błąd wczytywania produktów.";
            }
        });
    </script>
</body>
</html>