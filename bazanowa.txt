-- we don't know how to generate root <with-no-name> (class Root) :(

comment on database postgres is 'default administrative connection database';

grant connect, create, temporary on database neondb to neon_superuser;

grant connect, create, temporary on database "sklepInternetowy" to neon_superuser;

create table adres
(
    id_adresu    serial
        primary key,
    ulica        varchar(100),
    nr_domu      varchar(10) not null,
    nr_lokalu    varchar(10),
    kod_pocztowy char(6)     not null,
    miejscowosc  varchar(50) not null
);

alter table adres
    owner to neondb_owner;

grant usage on sequence adres_id_adresu_seq to rola_klient_niezarejestrowany;

grant usage on sequence adres_id_adresu_seq to rola_klient_zarejestrowany;

grant select, update, usage on sequence adres_id_adresu_seq to rola_administrator;

grant insert on adres to rola_klient_niezarejestrowany;

grant insert, select, update (ulica, nr_domu, nr_lokalu, kod_pocztowy, miejscowosc) on adres to rola_klient_zarejestrowany;

grant select on adres to rola_sprzedawca;

grant select on adres to rola_magazynier;

grant delete, insert, references, select, trigger, truncate, update on adres to rola_administrator;

create table kategoria
(
    id_kategorii    serial
        primary key,
    nazwa_kategorii varchar(50) not null,
    opis_kategorii  varchar(255)
);

alter table kategoria
    owner to neondb_owner;

grant usage on sequence kategoria_id_kategorii_seq to rola_klient_niezarejestrowany;

grant usage on sequence kategoria_id_kategorii_seq to rola_klient_zarejestrowany;

grant select, update, usage on sequence kategoria_id_kategorii_seq to rola_administrator;

grant select on kategoria to rola_klient_niezarejestrowany;

grant select on kategoria to rola_klient_zarejestrowany;

grant select on kategoria to rola_sprzedawca;

grant select on kategoria to rola_magazynier;

grant delete, insert, references, select, trigger, truncate, update on kategoria to rola_administrator;

create table rola
(
    id_roli    serial
        primary key,
    nazwa_roli varchar(30) not null
);

alter table rola
    owner to neondb_owner;

grant usage on sequence rola_id_roli_seq to rola_klient_niezarejestrowany;

grant usage on sequence rola_id_roli_seq to rola_klient_zarejestrowany;

grant select, update, usage on sequence rola_id_roli_seq to rola_administrator;

grant delete, insert, references, select, trigger, truncate, update on rola to rola_administrator;

create table klient
(
    id_klienta       serial
        primary key,
    imie             varchar(50)  not null,
    drugie_imie      varchar(50),
    nazwisko         varchar(50)  not null,
    adres_email      varchar(40)  not null
        unique,
    haslo_hash       varchar(255) not null,
    data_rejestracji timestamp    not null
);

alter table klient
    owner to neondb_owner;

grant usage on sequence klient_id_klienta_seq to rola_klient_niezarejestrowany;

grant usage on sequence klient_id_klienta_seq to rola_klient_zarejestrowany;

grant select, update, usage on sequence klient_id_klienta_seq to rola_administrator;

create index idx_klient_imie_nazwisko
    on klient (imie, nazwisko);

grant insert on klient to rola_klient_niezarejestrowany;

grant select, update (imie, drugie_imie, nazwisko, adres_email, haslo_hash) on klient to rola_klient_zarejestrowany;

grant select on klient to rola_sprzedawca;

grant select on klient to rola_magazynier;

grant delete, insert, references, select, trigger, truncate, update on klient to rola_administrator;

create table pracownik
(
    id_pracownika serial
        primary key,
    login         varchar(50)  not null
        unique,
    haslo_hash    varchar(255) not null,
    imie          varchar(50)  not null,
    nazwisko      varchar(50)  not null,
    plec          text,
    id_roli       integer      not null
        constraint fk_pracownik_rola
            references rola
);

alter table pracownik
    owner to neondb_owner;

grant usage on sequence pracownik_id_pracownika_seq to rola_klient_niezarejestrowany;

grant usage on sequence pracownik_id_pracownika_seq to rola_klient_zarejestrowany;

grant select, update, usage on sequence pracownik_id_pracownika_seq to rola_administrator;

grant delete, insert, references, select, trigger, truncate, update on pracownik to rola_administrator;

create table klient_adres
(
    klient2id_klienta integer not null
        constraint fk_ka_klient
            references klient,
    adres2id_adresu   integer not null
        constraint fk_ka_adres
            references adres,
    czy_domyslny      boolean default false,
    primary key (klient2id_klienta, adres2id_adresu)
);

alter table klient_adres
    owner to neondb_owner;

grant insert on klient_adres to rola_klient_niezarejestrowany;

grant insert, select, update (czy_domyslny) on klient_adres to rola_klient_zarejestrowany;

grant select on klient_adres to rola_sprzedawca;

grant select on klient_adres to rola_magazynier;

grant delete, insert, references, select, trigger, truncate, update on klient_adres to rola_administrator;

create table model_produktu
(
    id_modelu       serial
        primary key,
    nazwa_modelu    varchar(100)  not null,
    opis            text,
    cena_katalogowa numeric(8, 2) not null,
    zdjecie_url     varchar(255),
    id_kategorii    integer       not null
        constraint fk_model_kategoria
            references kategoria,
    stan_magazynowy integer default 100
);

alter table model_produktu
    owner to neondb_owner;

grant usage on sequence model_produktu_id_modelu_seq to rola_klient_niezarejestrowany;

grant usage on sequence model_produktu_id_modelu_seq to rola_klient_zarejestrowany;

grant select, update, usage on sequence model_produktu_id_modelu_seq to rola_administrator;

grant select on model_produktu to rola_klient_niezarejestrowany;

grant select on model_produktu to rola_klient_zarejestrowany;

grant select, update (opis, cena_katalogowa) on model_produktu to rola_sprzedawca;

grant select on model_produktu to rola_magazynier;

grant delete, insert, references, select, trigger, truncate, update on model_produktu to rola_administrator;

create table egzemplarz_produktu
(
    id_egzemplarza     serial
        primary key,
    numer_seryjny      varchar(50) not null
        unique,
    kod_wewnetrzny     varchar(50) not null
        unique,
    status_egzemplarza varchar(20) not null,
    id_modelu          integer     not null
        constraint fk_egzemplarz_model
            references model_produktu
);

alter table egzemplarz_produktu
    owner to neondb_owner;

grant usage on sequence egzemplarz_produktu_id_egzemplarza_seq to rola_klient_niezarejestrowany;

grant usage on sequence egzemplarz_produktu_id_egzemplarza_seq to rola_klient_zarejestrowany;

grant select, update, usage on sequence egzemplarz_produktu_id_egzemplarza_seq to rola_administrator;

grant select on egzemplarz_produktu to rola_sprzedawca;

grant select, update (status_egzemplarza) on egzemplarz_produktu to rola_magazynier;

grant delete, insert, references, select, trigger, truncate, update on egzemplarz_produktu to rola_administrator;

create table zamowienie
(
    id_zamowienia          serial
        primary key,
    numer_zamowienia       varchar(50)    not null
        unique,
    data_zlozenia          timestamp      not null,
    status_zamowienia      varchar(20)    not null,
    suma_calkowita         numeric(10, 2) not null,
    telefon_kontakt_do_zam varchar(9),
    email_kontakt_do_zam   varchar(40),
    id_adresu              integer        not null
        constraint fk_zam_adres
            references adres,
    id_klienta             integer        not null
        constraint fk_zam_klient
            references klient
);

alter table zamowienie
    owner to neondb_owner;

grant usage on sequence zamowienie_id_zamowienia_seq to rola_klient_niezarejestrowany;

grant usage on sequence zamowienie_id_zamowienia_seq to rola_klient_zarejestrowany;

grant select, update, usage on sequence zamowienie_id_zamowienia_seq to rola_administrator;

grant insert on zamowienie to rola_klient_niezarejestrowany;

grant insert, select on zamowienie to rola_klient_zarejestrowany;

grant select, update (status_zamowienia) on zamowienie to rola_sprzedawca;

grant select, update (status_zamowienia) on zamowienie to rola_magazynier;

grant delete, insert, references, select, trigger, truncate, update on zamowienie to rola_administrator;

create table pozycja_zamowienia
(
    id_pozycji           serial
        primary key,
    ilosc                integer        not null,
    cena_w_chwili_zakupu numeric(10, 2) not null,
    id_modelu            integer        not null
        constraint fk_poz_model
            references model_produktu,
    id_zamowienia        integer        not null
        constraint fk_poz_zamowienie
            references zamowienie
);

alter table pozycja_zamowienia
    owner to neondb_owner;

grant usage on sequence pozycja_zamowienia_id_pozycji_seq to rola_klient_niezarejestrowany;

grant usage on sequence pozycja_zamowienia_id_pozycji_seq to rola_klient_zarejestrowany;

grant select, update, usage on sequence pozycja_zamowienia_id_pozycji_seq to rola_administrator;

grant insert on pozycja_zamowienia to rola_klient_niezarejestrowany;

grant insert, select on pozycja_zamowienia to rola_klient_zarejestrowany;

grant select on pozycja_zamowienia to rola_sprzedawca;

grant select on pozycja_zamowienia to rola_magazynier;

grant delete, insert, references, select, trigger, truncate, update on pozycja_zamowienia to rola_administrator;

create table realizacja_pozycji
(
    id_realizacji                     serial
        primary key,
    pozycja_zamowieniaid_pozycji      integer not null
        constraint fk_real_pozycja
            references pozycja_zamowienia,
    egzemplarz_produktuid_egzemplarza integer not null
        constraint fk_real_egzemplarz
            references egzemplarz_produktu
);

alter table realizacja_pozycji
    owner to neondb_owner;

grant usage on sequence realizacja_pozycji_id_realizacji_seq to rola_klient_niezarejestrowany;

grant usage on sequence realizacja_pozycji_id_realizacji_seq to rola_klient_zarejestrowany;

grant select, update, usage on sequence realizacja_pozycji_id_realizacji_seq to rola_administrator;

grant select on realizacja_pozycji to rola_sprzedawca;

grant select on realizacja_pozycji to rola_magazynier;

grant delete, insert, references, select, trigger, truncate, update on realizacja_pozycji to rola_administrator;

create table log_zmiana_statusu
(
    id_logu       serial
        primary key,
    stary_status  text,
    nowy_status   text,
    data_zmiany   date,
    id_zamowienia integer not null
        constraint fk_log_zamowienie
            references zamowienie,
    id_pracownika integer not null
        constraint fk_log_pracownik
            references pracownik
);

alter table log_zmiana_statusu
    owner to neondb_owner;

grant usage on sequence log_zmiana_statusu_id_logu_seq to rola_klient_niezarejestrowany;

grant usage on sequence log_zmiana_statusu_id_logu_seq to rola_klient_zarejestrowany;

grant select, update, usage on sequence log_zmiana_statusu_id_logu_seq to rola_administrator;

grant select on log_zmiana_statusu to rola_klient_zarejestrowany;

grant select on log_zmiana_statusu to rola_sprzedawca;

grant select on log_zmiana_statusu to rola_magazynier;

grant select on log_zmiana_statusu to rola_administrator;

create table telefony_pracownikow
(
    id_telefonu            serial
        primary key,
    numer                  text,
    typ                    text,
    pracownikid_pracownika integer not null
        constraint fk_tel_pracownik
            references pracownik
);

alter table telefony_pracownikow
    owner to neondb_owner;

grant usage on sequence telefony_pracownikow_id_telefonu_seq to rola_klient_niezarejestrowany;

grant usage on sequence telefony_pracownikow_id_telefonu_seq to rola_klient_zarejestrowany;

grant select, update, usage on sequence telefony_pracownikow_id_telefonu_seq to rola_administrator;

grant delete, insert, references, select, trigger, truncate, update on telefony_pracownikow to rola_administrator;

create view v_dostepne_produkty
            (id_modelu, nazwa_modelu, nazwa_kategorii, cena_katalogowa, ilosc_dostepna_fizycznie, ilosc_teoretyczna) as
SELECT m.id_modelu,
       m.nazwa_modelu,
       k.nazwa_kategorii,
       m.cena_katalogowa,
       (SELECT count(*) AS count
        FROM egzemplarz_produktu e
        WHERE e.id_modelu = m.id_modelu
          AND e.status_egzemplarza::text = 'Dostepny'::text) AS ilosc_dostepna_fizycznie,
       m.stan_magazynowy                                     AS ilosc_teoretyczna
FROM model_produktu m
         JOIN kategoria k ON m.id_kategorii = k.id_kategorii
WHERE m.stan_magazynowy > 0;

alter table v_dostepne_produkty
    owner to neondb_owner;

grant select on v_dostepne_produkty to rola_klient_niezarejestrowany;

grant select on v_dostepne_produkty to rola_klient_zarejestrowany;

grant select on v_dostepne_produkty to rola_sprzedawca;

grant select on v_dostepne_produkty to rola_magazynier;

grant select on v_dostepne_produkty to rola_administrator;

create view v_szczegoly_zamowienia
            (numer_zamowienia, data_zlozenia, status_zamowienia, suma_calkowita, imie, nazwisko, miejscowosc, ulica,
             nr_domu, nr_lokalu, ilosc, cena_w_chwili_zakupu, nazwa_modelu)
as
SELECT z.numer_zamowienia,
       z.data_zlozenia,
       z.status_zamowienia,
       z.suma_calkowita,
       k.imie,
       k.nazwisko,
       a.miejscowosc,
       a.ulica,
       a.nr_domu,
       a.nr_lokalu,
       pz.ilosc,
       pz.cena_w_chwili_zakupu,
       m.nazwa_modelu
FROM zamowienie z
         JOIN klient k ON z.id_klienta = k.id_klienta
         JOIN adres a ON z.id_adresu = a.id_adresu
         JOIN pozycja_zamowienia pz ON z.id_zamowienia = pz.id_zamowienia
         JOIN model_produktu m ON pz.id_modelu = m.id_modelu;

alter table v_szczegoly_zamowienia
    owner to neondb_owner;

grant select on v_szczegoly_zamowienia to rola_klient_niezarejestrowany;

grant select on v_szczegoly_zamowienia to rola_klient_zarejestrowany;

grant select on v_szczegoly_zamowienia to rola_sprzedawca;

grant select on v_szczegoly_zamowienia to rola_magazynier;

grant select on v_szczegoly_zamowienia to rola_administrator;

create function func_zapisz_cene_historyczna() returns trigger
    language plpgsql
as
$$
BEGIN
    -- Sprawdzamy czy cena nie została podana lub jest 0
    IF NEW.cena_w_chwili_zakupu IS NULL OR NEW.cena_w_chwili_zakupu = 0 THEN
        -- Pobieramy aktualną cenę z katalogu i przypisujemy do nowego rekordu
        SELECT cena_katalogowa INTO NEW.cena_w_chwili_zakupu
        FROM model_produktu
        WHERE id_modelu = NEW.id_modelu;
    END IF;
    RETURN NEW; -- Zwracamy zmodyfikowany rekord
END;
$$;

alter function func_zapisz_cene_historyczna() owner to neondb_owner;

create function func_aktualizacja_stanu_licznika() returns trigger
    language plpgsql
as
$$
BEGIN
    -- Zmniejszamy stan magazynowy modelu o tyle sztuk, ile klient kupił
    UPDATE model_produktu
    SET stan_magazynowy = stan_magazynowy - NEW.ilosc
    WHERE id_modelu = NEW.id_modelu;

    RETURN NEW;
END;
$$;

alter function func_aktualizacja_stanu_licznika() owner to neondb_owner;

